<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title class="header-title">Gesti√≥n de Experiencias</ion-title>
  </ion-toolbar>
  
</ion-header>
 
<ion-content [fullscreen]="true">
  @if (currentView() === 'list') {
    <ion-fab class="fab-bottom-right fab-standard" vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button (click)="navegarAFormulario()" aria-label="Nueva experiencia">
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  }
  @if (currentView() === 'list') {
    <div class="ion-padding">
      @if(listaCatas().length > 0) {
        <ion-grid>
          <ion-row>
            @for (experiencia of listaCatas(); track experiencia.id) {
              <ion-col size="12" size-md="6" size-lg="4">
                <ion-card>
                <ion-card-header>
                  <ion-card-title> {{ experiencia.name }}</ion-card-title>
                </ion-card-header>

                <ion-card-content>
                  <ion-item lines="none">
                    <ion-icon name="calendar" slot="start"></ion-icon>
                    <ion-label>
                      <p> {{ experiencia.fecha | date:'short' }}</p>
                    </ion-label>
                  </ion-item>

                  <p class="descripcion">{{ experiencia.description }}</p>

                  <ion-grid class="stats-grid">
                    <ion-row>
                      <ion-col>
                        <div class="stat-item">
                          <strong class="stat-number text-pink">
                            {{ experiencia.capacidad }}
                          </strong>
                          <span class="stat-label">Capacidad</span>
                        </div>
                      </ion-col>
                      <ion-col>
                        <div class="stat-item">
                          <strong class="stat-number text-green">
                            ${{ experiencia.costo }}
                          </strong>
                          <span class="stat-label">Costo</span>
                        </div>
                      </ion-col>
                    </ion-row>
                  </ion-grid>

                  <ion-grid class="actions-grid">
                    <ion-row>
                      <ion-col>
                        <ion-button 
                          expand="block" 
                          color="warning" 
                          size="small"
                          (click)="navegarAEdicion(experiencia.id)">
                           Editar
                        </ion-button>
                      </ion-col>
                      <ion-col>
                        <ion-button 
                          expand="block" 
                          color="primary" 
                          size="small"
                          (click)="verAsistentesDeExperiencia(experiencia.id)">
                           Asistentes
                        </ion-button>
                      </ion-col>
                      <ion-col>
                        <ion-button 
                          expand="block" 
                          color="danger" 
                          size="small"
                          (click)="confirmarEliminar(experiencia.id)">
                           Eliminar
                        </ion-button>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </ion-card-content>
              </ion-card>
            </ion-col>
            }
          </ion-row>
        </ion-grid>
      } @else {
        <div class="empty-state">
          <ion-card>
            <ion-card-content class="ion-text-center">
              <h2> No hay experiencias programadas</h2>
              <p class="ion-margin-top">Comienza creando tu primera experiencia</p>
              <ion-button 
                class="ion-margin-top"
                (click)="navegarAFormulario()">
                Crear Primera Experiencia
              </ion-button>
            </ion-card-content>
          </ion-card>
        </div>
      }
    </div>
  } @else if(currentView() === 'form') {
    <div class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            {{ isEditMode() ? '‚úèÔ∏è Editar Experiencia' : '‚ûï Agregar Nueva Experiencia' }}
          </ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <form [formGroup]="experienciaForm">
            <!-- Nombre -->
            <ion-item>
              <ion-label position="stacked">üè∑Ô∏è Nombre *</ion-label>
              <ion-input 
                formControlName="nombre" 
                placeholder="Ej: Cata de Tequila Ultra Premium"
                type="text">
              </ion-input>
            </ion-item>
            @if(experienciaForm.get('nombre')?.invalid && experienciaForm.get('nombre')?.touched) {
              <ion-text color="danger" class="ion-padding-start">
                <small>Nombre requerido (m√≠n. 3 caracteres)</small>
              </ion-text>
            }

            <!-- Fecha y Hora -->
            <ion-grid>
              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="stacked">üìÖ Fecha *</ion-label>
                    <ion-input 
                      formControlName="fecha" 
                      type="date">
                    </ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="stacked">‚è∞ Hora *</ion-label>
                    <ion-input 
                      formControlName="hora" 
                      type="time">
                    </ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>

            <!-- Descripci√≥n -->
            <ion-item>
              <ion-label position="stacked">üìù Descripci√≥n</ion-label>
              <ion-textarea 
                formControlName="descripcion" 
                rows="4" 
                placeholder="Detalles de la experiencia, lugar, costo, etc.">
              </ion-textarea>
            </ion-item>

            <!-- Capacidad y Costo -->
            <ion-grid>
              <ion-row>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="stacked">üë• Capacidad *</ion-label>
                    <ion-input formControlName="capacidad" type="number" placeholder="20"></ion-input>
                  </ion-item>
                  @if(experienciaForm.get('capacidad')?.invalid && experienciaForm.get('capacidad')?.touched) {
                    <ion-text color="danger" class="ion-padding-start">
                      <small>La capacidad debe ser mayor a 0</small>
                    </ion-text>
                  }
                </ion-col>
                <ion-col size="12" size-md="6">
                  <ion-item>
                    <ion-label position="stacked">üí≤ Costo *</ion-label>
                    <ion-input formControlName="costo" type="number" placeholder="250"></ion-input>
                  </ion-item>
                  @if(experienciaForm.get('costo')?.invalid && experienciaForm.get('costo')?.touched) {
                    <ion-text color="danger" class="ion-padding-start">
                      <small>El costo no puede ser negativo</small>
                    </ion-text>
                  }
                </ion-col>
              </ion-row>
            </ion-grid>

            <!-- Acciones del Formulario -->
            <ion-grid class="ion-margin-top">
              <ion-row>
                <ion-col>
                  <ion-button 
                    expand="block" 
                    color="medium" 
                    (click)="navegarALista()">
                    Cancelar
                  </ion-button>
                </ion-col>
                <ion-col>
                  <ion-button 
                    expand="block" 
                    color="primary" 
                    (click)="guardar()"
                    [disabled]="experienciaForm.invalid">
                    <ion-icon slot="start" name="save"></ion-icon>
                    {{ isEditMode() ? 'Actualizar' : 'Guardar' }}
                  </ion-button>
                </ion-col>
              </ion-row>
            </ion-grid>
          </form>
        </ion-card-content>
      </ion-card>
    </div>
  }

  <!-- Action Sheet para acciones -->
  <ion-action-sheet
    [isOpen]="isActionSheetOpen()"
    header="Acciones"
    [buttons]="actionSheetButtons"
    (didDismiss)="cerrarAcciones()">
  </ion-action-sheet>

  <!-- Alert para confirmar eliminaci√≥n -->
  <ion-alert
    [isOpen]="isDeleteAlertOpen()"
    header="Confirmar Eliminaci√≥n"
    message="¬øEst√°s seguro de que quieres eliminar esta experiencia?"
    [buttons]="alertButtons"
    (didDismiss)="isDeleteAlertOpen.set(false)">
  </ion-alert>

  <!-- Alert para resultado de operaciones -->
  <ion-alert
    [isOpen]="resultAlertOpen()"
    [header]="resultAlertHeader()"
    [message]="resultAlertMessage()"
    [buttons]="resultAlertButtons"
    (didDismiss)="onResultAlertDismiss()">
  </ion-alert>

  @if (currentView() === 'attendees') {
      <ion-button color="medium" fill="clear" (click)="navegarALista()" style="margin: 8px 12px;">‚Üê Volver</ion-button>
      
      @if(selectedExperienciaId()) {
        <ion-card class="cata-info-card">
          <ion-card-header>
            <ion-card-title>Asistentes: {{ getCataName(selectedExperienciaId()!) }}</ion-card-title>
          </ion-card-header>
        </ion-card>
      }

      @if(isLoadingAsistentes()) {
        <ion-card class="loading-card">
          <ion-card-content class="ion-text-center">
            <div class="loading-spinner">
              <ion-spinner name="crescent" color="primary"></ion-spinner>
            </div>
            <p class="loading-text">Cargando asistentes...</p>
          </ion-card-content>
        </ion-card>
      } @else {
        @if(asistentesList().length === 0) {
          <ion-card>
            <ion-card-content class="ion-text-center">
              <h3>No hay visitantes registrados para esta experiencia.</h3>
            </ion-card-content>
          </ion-card>
        } @else {
          <div style="padding: 0 12px;">
            <ion-grid>
              <ion-row>
                @for (v of asistentesList(); track v.id) {
                  <ion-col size="12" size-md="6">
                    <ion-card>
                      <ion-card-header>
                        <ion-card-title>{{ asistentesList().indexOf(v) + 1 }}. {{ v.nome }}</ion-card-title>
                      </ion-card-header>
                      <ion-card-content>
                        <p><strong>üìß</strong> {{ v.email }}</p>
                        <p><strong>üìä Estado:</strong> 
                          <ion-badge [color]="v.status === 1 ? 'success' : 'warning'">
                            {{ v.status === 1 ? 'APROBADA' : 'PENDIENTE' }}
                          </ion-badge>
                        </p>
                        <ion-grid>
                          <ion-row>
                            <ion-col>
                              <ion-button expand="block" color="success" (click)="cambiarEstadoVisitante(v.id, 1)" [disabled]="v.__updating || v.status === 1">
                                @if(v.__updating) {
                                  <ion-spinner name="crescent"></ion-spinner>
                                } @else {
                                  Aprobar
                                }
                              </ion-button>
                            </ion-col>
                            <ion-col>
                              <ion-button expand="block" color="danger" (click)="cambiarEstadoVisitante(v.id, 0)" [disabled]="v.__updating || v.status === 0">
                                @if(v.__updating) {
                                  <ion-spinner name="crescent"></ion-spinner>
                                } @else {
                                  Revocar
                                }
                              </ion-button>
                            </ion-col>
                          </ion-row>
                        </ion-grid>
                      </ion-card-content>
                    </ion-card>
                  </ion-col>
                }
              </ion-row>
            </ion-grid>

            <!-- Resumen de estad√≠sticas -->
            <ion-card style="margin: 12px 0;">
              <ion-card-header>
                <ion-card-title>Resumen</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-grid class="stats-grid">
                  <ion-row>
                    <ion-col size="6">
                      <div class="stat-item">
                        <strong class="stat-number text-primary">
                          {{ asistentesList().length }}
                        </strong>
                        <span class="stat-label">Total Registrados</span>
                      </div>
                    </ion-col>
                    <ion-col size="6">
                      <div class="stat-item">
                        <strong class="stat-number text-green">
                          {{ getAsistentesAprobadosCount() }}
                        </strong>
                        <span class="stat-label">Asistentes Aprobados</span>
                      </div>
                    </ion-col>
                  </ion-row>
                  <ion-row>
                    <ion-col size="6">
                      <div class="stat-item">
                        <strong class="stat-number text-warning">
                          {{ getAsistentesPendientesCount() }}
                        </strong>
                        <span class="stat-label">Pendientes</span>
                      </div>
                    </ion-col>
                    <ion-col size="6">
                      <div class="stat-item">
                        <strong class="stat-number text-pink">
                          {{ getCataCapacidad(selectedExperienciaId()!) }}
                        </strong>
                        <span class="stat-label">Capacidad</span>
                      </div>
                    </ion-col>
                  </ion-row>
                </ion-grid>
              </ion-card-content>
            </ion-card>
          </div>
        }
      }
  }
</ion-content>
