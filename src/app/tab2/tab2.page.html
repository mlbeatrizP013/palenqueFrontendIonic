<app-header></app-header>

<ion-content class="ion-padding" [scrollY]="true">
  @if(currentView() === 'list') {
    <ion-searchbar value="" placeholder="Buscar producto..." (ionInput)="searchTerm.set($event.detail.value ?? '')"></ion-searchbar>

    <!-- Filtro por estado -->
    <ion-segment value="todos" (ionChange)="onFilterChange($event)">
      <ion-segment-button value="todos"><ion-label>Todos</ion-label></ion-segment-button>
      <ion-segment-button value="activo"><ion-label>Activos</ion-label></ion-segment-button>
      <ion-segment-button value="stock_bajo"><ion-label>Stock Bajo</ion-label></ion-segment-button>
      <ion-segment-button value="sin_stock"><ion-label>Sin Stock</ion-label></ion-segment-button>
      <ion-segment-button value="apartados" (click)="toggleApartados()"><ion-label>Apartados</ion-label></ion-segment-button>
    </ion-segment>

    <!-- Filtro por categor√≠a -->
    <ion-item>
      <ion-label>Categor√≠a:</ion-label>
      <ion-select (ionChange)="onCategoryChange($event.detail.value)">
        <ion-select-option value="todos">Todas las categor√≠as</ion-select-option>
        @for (cat of categorias(); track cat.id) {
          <ion-select-option [value]="cat.nombre">{{ cat.nombre }}</ion-select-option>
        }
      </ion-select>
    </ion-item>

    <!-- Empty state: no hay registros -->
    @if(productos().length === 0) {
      <ion-card class="ion-text-center ion-margin-top">
        <ion-card-header>
          <ion-card-title>No hay registros en la tienda</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>Comienza creando tu primer producto</p>
          <ion-button color="primary" expand="block" (click)="nuevaProducto()">
            <ion-icon slot="start" name="add"></ion-icon>
            Crear Primer Producto
          </ion-button>
        </ion-card-content>
      </ion-card>
    }

    <!-- Empty state: no hay resultados por filtro -->
    @if(productos().length > 0 && productosFiltrados().length === 0) {
      <ion-card class="ion-text-center ion-margin-top">
        <ion-card-header>
          <ion-card-title>No hay productos que coincidan</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>Intenta cambiar los filtros o la b√∫squeda</p>
        </ion-card-content>
      </ion-card>
    }

    <!-- Grid de productos con controles de apartado -->
    @if(productosFiltrados().length > 0) {
      <div class="productos-container">
        <ion-grid>
          <ion-row>
            @for (p of productosFiltrados(); track p.id) {
              <ion-col size="12" size-md="6">
                <ion-card>
                  <img [src]="p.imagen" alt="{{ p.nombre }}" style="width:100%;height:200px;object-fit:cover;" />
                  <ion-card-header>
                    <ion-card-title>{{ p.nombre }}</ion-card-title>
                  </ion-card-header>
                  <ion-card-content>
                    <p><strong>Categor√≠a:</strong> {{ p.categoria }}</p>
                    <p><strong>Precio:</strong> {{ p.precioMXN | currency:'MXN' }}</p>
                    <p><strong>Stock disponible:</strong> {{ p.stockActual }} unidades</p>
                    <p><strong>Estado:</strong> 
                      @if(p.stockActual === 0) {
                        <ion-badge color="danger">Sin Stock</ion-badge>
                      } @else if(p.stockActual <= p.stockMinimo) {
                        <ion-badge color="warning">Stock Bajo</ion-badge>
                      } @else {
                        <ion-badge color="success">Activo</ion-badge>
                      }
                    </p>
                    
                    <!-- Botones de administraci√≥n -->
                    <ion-grid style="margin-top: 1rem;">
                      <ion-row>
                        <ion-col size="4">
                          <ion-button expand="block" size="small" style="--background: #4CAF50; --color: white;" (click)="verDetalle(p)">Ver</ion-button>
                        </ion-col>
                        <ion-col size="4">
                          <ion-button expand="block" size="small" style="--background: #FFC107; --color: #333;" (click)="editarProducto(p)">Editar</ion-button>
                        </ion-col>
                        <ion-col size="4">
                          <ion-button expand="block" size="small" color="danger" (click)="eliminarProducto(p.id)">Eliminar</ion-button>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </ion-card-content>
                </ion-card>
              </ion-col>
            }
          </ion-row>
        </ion-grid>
      </div>
    }

    <ion-fab class="fab-bottom-right fab-standard" vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button (click)="nuevaProducto()">
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  } @else if(currentView() === 'form') {
    <app-producto-formulario
      [productoEditando]="productoEditando()"
      (guardarProducto)="guardarProducto($event)"
      (cancelar)="cancelarForm()">
    </app-producto-formulario>
  } @else if(currentView() === 'detalle') {
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ productoSeleccionado()?.nombre }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <img [src]="productoSeleccionado()?.imagen" alt="imagen" style="width:100%;height:auto;border-radius:8px;" />
        <p>{{ productoSeleccionado()?.descripcion }}</p>
        <p><strong>Precio:</strong> {{ productoSeleccionado()?.precioMXN | currency:'MXN' }}</p>
        <p><strong>Stock:</strong> {{ productoSeleccionado()?.stockActual }} unidades</p>

        <ion-grid>
          <ion-row>
            <ion-col>
              <ion-button expand="block" (click)="editarDelDetalle(productoSeleccionado()!)">Editar</ion-button>
            </ion-col>
            <ion-col>
              <ion-button expand="block" color="medium" (click)="volverALista()">Volver</ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>
  } @else if(currentView() === 'apartados') {
    <!-- Vista de Apartados -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Todos los Apartados</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>Mostrando todos los productos apartados de todos los usuarios</p>
        <ion-button expand="block" color="medium" (click)="toggleApartados()">Volver a la lista</ion-button>
      </ion-card-content>
    </ion-card>

    @if(apartados().length === 0) {
      <ion-card class="ion-text-center">
        <ion-card-content>
          <p>No hay apartados registrados</p>
        </ion-card-content>
      </ion-card>
    } @else {
      @for (apartado of apartados(); track apartado.id) {
        <ion-card style="position: relative; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1rem;">
          <!-- Bot√≥n de cerrar en la esquina -->
          <ion-button 
            style="position: absolute; top: 8px; right: 8px; z-index: 10;" 
            size="small" 
            color="danger" 
            fill="solid"
            shape="round"
            (click)="eliminarApartado(apartado.id)">
            ‚úï
          </ion-button>

          <ion-card-content style="padding: 16px;">
            <div style="display: flex; flex-direction: column; gap: 14px;">
              <!-- Producto -->
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; min-width: 32px;">üç∑</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #8b4513; font-size: 13px; margin-bottom: 2px;">Producto:</div>
                  <div style="color: #333; font-size: 15px;">{{ apartado.bebida?.nombre || 'Producto no disponible' }}</div>
                </div>
              </div>

              <!-- Usuario -->
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; min-width: 32px;">üë§</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #8b4513; font-size: 13px; margin-bottom: 2px;">Usuario:</div>
                  <div style="color: #333; font-size: 15px;">{{ apartado.usuario?.nome || 'Usuario desconocido' }}</div>
                </div>
              </div>

              <!-- Correo -->
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; min-width: 32px;">üìß</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #8b4513; font-size: 13px; margin-bottom: 2px;">Correo:</div>
                  <div style="color: #333; font-size: 15px;">{{ apartado.usuario?.email || 'N/A' }}</div>
                </div>
              </div>

              <!-- Cantidad -->
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; min-width: 32px;">üî¢</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #8b4513; font-size: 13px; margin-bottom: 2px;">Cantidad:</div>
                  <div style="color: #333; font-size: 15px;">{{ apartado.cantidad }} unidad(es)</div>
                </div>
              </div>

              <!-- Total -->
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <span style="font-size: 24px; min-width: 32px;">üí∞</span>
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #8b4513; font-size: 13px; margin-bottom: 2px;">Total:</div>
                  <div style="color: #ff6b35; font-size: 20px; font-weight: bold;">{{ calcularTotal(apartado) | currency:'MXN' }}</div>
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      }
    }
  }
</ion-content>
